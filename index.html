<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººæ¯æ—¥å¤ç›˜å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f9fbfb;
            padding: 16px;
            color: #2d3748;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 0.5px solid #eee;
            white-space: nowrap;
        }

        .header h1 {
            font-size: 20px;
            color: #4a5568;
            font-weight: 600;
        }
        .auto-save-tip{
            font-size: 12px;
            color: #4aae9b;
            margin-top: 6px;
            display: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(2, 1fr) !important;
            grid-template-rows: repeat(2, 1fr);
            gap: 16px;
            width: 100%;
            flex: 1;
        }

        .card {
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            height: 100%;
            border: 0.5px solid #f0f0f0;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            white-space: nowrap;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
        }

        .card-work .card-title {
            color: #4aae9b;
        }
        .card-work .card-title svg {
            fill: #4aae9b;
        }
        .card-work [contenteditable] {
            background-color: #ffffff;
            border-color: #d5ece9;
        }
        .card-work [contenteditable]:focus {
            border-color: #4aae9b;
            box-shadow: 0 0 0 3px rgba(74, 174, 155, 0.1);
        }
        .card-work .btn-img {
            color: #4aae9b;
            background-color: #f5fcfb;
        }
        .card-work .btn-img:hover {
            background-color: #eaf6f5;
        }

        .card-plan .card-title {
            color: #d4a76a;
        }
        .card-plan .card-title svg {
            fill: #d4a76a;
        }
        .card-plan [contenteditable] {
            background-color: #ffffff;
            border-color: #f5e6c8;
        }
        .card-plan [contenteditable]:focus {
            border-color: #d4a76a;
            box-shadow: 0 0 0 3px rgba(212, 167, 106, 0.1);
        }
        .card-plan .btn-img {
            color: #d4a76a;
            background-color: #fef9e7;
        }
        .card-plan .btn-img:hover {
            background-color: #fbf6e8;
        }

        .card-reflection .card-title {
            color: #9d8ed9;
        }
        .card-reflection .card-title svg {
            fill: #9d8ed9;
        }
        .card-reflection [contenteditable] {
            background-color: #ffffff;
            border-color: #e6e1f5;
        }
        .card-reflection [contenteditable]:focus {
            border-color: #9d8ed9;
            box-shadow: 0 0 0 3px rgba(157, 142, 217, 0.1);
        }
        .card-reflection .btn-img {
            color: #9d8ed9;
            background-color: #fcfaff;
        }
        .card-reflection .btn-img:hover {
            background-color: #f0edf8;
        }

        .card-blessing .card-title {
            color: #e899a8;
        }
        .card-blessing .card-title svg {
            fill: #e899a8;
        }
        .card-blessing [contenteditable] {
            background-color: #ffffff;
            border-color: #fde5e9;
        }
        .card-blessing [contenteditable]:focus {
            border-color: #e899a8;
            box-shadow: 0 0 0 3px rgba(232, 153, 168, 0.1);
        }
        .card-blessing .btn-img {
            color: #e899a8;
            background-color: #fff5f7;
        }
        .card-blessing .btn-img:hover {
            background-color: #fef1f3;
        }

        .btn-img {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .content {
            flex: 1;
            display: flex;
        }

        [contenteditable] {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            padding: 12px;
            resize: none;
            font-size: 14px;
            line-height: 1.6;
            border: 0.5px solid #eee;
            outline: none;
            overflow-y: auto;
        }

        [contenteditable]:empty:before {
            content: attr(placeholder);
            color: #a0aec0;
            pointer-events: none;
            display: block;
        }

        [contenteditable] img {
            max-width: 100px;
            max-height: 100px;
            vertical-align: middle;
            margin: 0 4px;
        }

        .controls {
            width: 100%;
            max-width: 1200px;
            margin: 16px auto 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            white-space: nowrap;
            flex-wrap: wrap;
            row-gap: 10px;
        }

        .history-select {
            padding: 6px 10px;
            border: 0.5px solid #f0f0f0;
            border-radius: 6px;
            font-size: 12px;
            color: #2d3748;
            background-color: #ffffff;
            cursor: pointer;
            white-space: nowrap;
        }

        .history-select:focus {
            outline: none;
            border-color: #4aae9b;
            box-shadow: 0 0 0 3px rgba(74, 174, 155, 0.1);
        }

        .search-box {
            padding: 6px 10px;
            border: 0.5px solid #f0f0f0;
            border-radius: 6px;
            font-size: 12px;
            color: #2d3748;
            background-color: #ffffff;
            white-space: nowrap;
            flex: 1 0 150px;
            margin: 0 10px;
        }

        .search-box:focus {
            outline: none;
            border-color: #4aae9b;
            box-shadow: 0 0 0 3px rgba(74, 174, 155, 0.1);
        }

        .summary-setting {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 10px;
        }

        .summary-type {
            padding: 6px 10px;
            border: 0.5px solid #f0f0f0;
            border-radius: 6px;
            font-size: 12px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
            font-weight: 500;
            white-space: nowrap;
        }

        .btn-danger {
            background-color: #e57373;
            color: #ffffff;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
            transform: translateY(-1px);
        }

        .btn-search {
            background-color: #f0932b;
            color: #ffffff;
        }

        .btn-search:hover {
            background-color: #f39c12;
            transform: translateY(-1px);
        }

        .btn-summary {
            background-color: #2196f3;
            color: #ffffff;
        }

        .btn-summary:hover {
            background-color: #1976d2;
            transform: translateY(-1px);
        }

        .btn-export {
            background-color: #9c27b0;
            color: #ffffff;
        }

        .btn-export:hover {
            background-color: #7b1fa2;
            transform: translateY(-1px);
        }

        .btn-import {
            background-color: #009688;
            color: #ffffff;
        }

        .btn-import:hover {
            background-color: #00796b;
            transform: translateY(-1px);
        }

        /* å¼¹çª—é€šç”¨æ ·å¼ */
        .search-modal,.summary-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .modal-content {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
        }

        .result-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 0.5px solid #eee;
            border-radius: 4px;
        }

        .result-date {
            font-weight: 600;
            color: #4aae9b;
        }

        .result-content {
            margin-top: 5px;
            color: #2d3748;
        }

        .summary-title {
            font-size: 18px;
            font-weight: 600;
            color: #4a5568;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .summary-section {
            margin-bottom: 15px;
        }

        .summary-section h3 {
            font-size: 16px;
            color: #4aae9b;
            margin-bottom: 8px;
        }

        .summary-section p {
            line-height: 1.6;
            color: #2d3748;
        }

        .close-modal {
            margin-top: 20px;
            padding: 6px 15px;
            border: none;
            border-radius: 4px;
            background-color: #4aae9b;
            color: #ffffff;
            cursor: pointer;
        }

        .close-modal:hover {
            background-color: #3b9181;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: repeat(2, 1fr) !important;
                grid-template-rows: repeat(2, 1fr);
            }
            .header h1 {
                font-size: 16px;
            }
            .controls {
                flex-wrap: wrap;
                gap: 4px;
                font-size: 10px;
            }
            .btn {
                padding: 4px 8px;
                font-size: 10px;
            }
            .history-select,.summary-type {
                padding: 4px 8px;
                font-size: 10px;
                flex: 1 0 120px;
            }
            .search-box {
                flex: 1 0 120px;
                margin: 4px 0;
            }
            .btn-group {
                flex: 1 0 180px;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="today-title"></h1>
        <div class="auto-save-tip" id="auto-save-tip">âœ… å†…å®¹å·²è‡ªåŠ¨ä¿å­˜</div>
    </div>

    <div class="container">
        <div class="card card-work">
            <div class="card-header">
                <div class="card-title">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    ä»Šæ—¥å·¥ä½œ
                </div>
                <button class="btn-img" onclick="uploadImgToText('work-today')">ğŸ“· ä¼ å›¾</button>
            </div>
            <div class="content">
                <div id="work-today" placeholder="è®°å½•ä»Šæ—¥å®Œæˆçš„å·¥ä½œå†…å®¹..." contenteditable="true"></div>
            </div>
        </div>

        <div class="card card-plan">
            <div class="card-header">
                <div class="card-title">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-2 14l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>
                    </svg>
                    æ˜æ—¥æ‰“ç®—
                </div>
                <button class="btn-img" onclick="uploadImgToText('plan-tomorrow')">ğŸ“· ä¼ å›¾</button>
            </div>
            <div class="content">
                <div id="plan-tomorrow" placeholder="è§„åˆ’æ˜æ—¥è¦åšçš„äº‹é¡¹..." contenteditable="true"></div>
            </div>
        </div>

        <div class="card card-reflection">
            <div class="card-header">
                <div class="card-title">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                    </svg>
                    ä»Šæ—¥åæ€
                </div>
                <button class="btn-img" onclick="uploadImgToText('reflection-today')">ğŸ“· ä¼ å›¾</button>
            </div>
            <div class="content">
                <div id="reflection-today" placeholder="åæ€ä»Šæ—¥çš„ä¸è¶³ä¸æ”¶è·..." contenteditable="true"></div>
            </div>
        </div>

        <div class="card card-blessing">
            <div class="card-header">
                <div class="card-title">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                    ä»Šæ—¥å°ç¡®å¹¸
                </div>
                <button class="btn-img" onclick="uploadImgToText('blessing-today')">ğŸ“· ä¼ å›¾</button>
            </div>
            <div class="content">
                <div id="blessing-today" placeholder="è®°å½•ä»Šæ—¥çš„å°ç¾å¥½ç¬é—´..." contenteditable="true"></div>
            </div>
        </div>
    </div>

    <div class="controls">
        <select id="history-date" class="history-select" onchange="loadHistory()"></select>
        <input type="text" class="search-box" id="search-input" placeholder="è¾“å…¥å…³é”®è¯æœç´¢å¤ç›˜è®°å½•...">
        <div class="summary-setting">
            <select class="summary-type" id="summary-type">
                <option value="week">æŒ‰å‘¨æ±‡æ€»</option>
                <option value="month">æŒ‰æœˆæ±‡æ€»</option>
            </select>
        </div>
        <div class="btn-group">
            <button class="btn btn-export" onclick="exportData()">ğŸ“¤ å¯¼å‡ºè®°å½•</button>
            <button class="btn btn-import" onclick="importData()">ğŸ“¥ å¯¼å…¥è®°å½•</button>
            <button class="btn btn-search" onclick="searchRecords()">ğŸ” æœç´¢</button>
            <button class="btn btn-danger" onclick="deleteHistory()">ğŸ—‘ï¸ åˆ é™¤</button>
            <button class="btn btn-summary" onclick="generateSummary()">ğŸ“Š ç”Ÿæˆæ±‡æ€»</button>
        </div>
    </div>

    <!-- æœç´¢å¼¹çª— -->
    <div class="search-modal" id="search-modal">
        <div class="modal-content">
            <h3 style="margin-bottom:15px;color:#4aae9b;">æœç´¢ç»“æœ</h3>
            <div id="result-list"></div>
            <button class="close-modal" onclick="closeModal('search-modal')">å…³é—­</button>
        </div>
    </div>

    <!-- æ±‡æ€»å¼¹çª— -->
    <div class="summary-modal" id="summary-modal">
        <div class="modal-content">
            <h2 class="summary-title" id="summary-title"></h2>
            <div id="summary-content"></div>
            <button class="close-modal" onclick="closeModal('summary-modal')">å…³é—­</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/file-saver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        let currentDate = getToday();
        let autoSaveTimer = null;

        // è·å–ä»Šæ—¥æ—¥æœŸ æ ¼å¼2026-01-29
        function getToday() {
            return new Date().toISOString().split('T')[0];
        }

        function getYesterday() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return yesterday.toISOString().split('T')[0];
        }

        // è®¾ç½®é¡¶éƒ¨ä»Šæ—¥æ ‡é¢˜
        function setHeaderTitle() {
            const today = getToday();
            document.getElementById('today-title').innerText = `${today} æ¯æ—¥å¤ç›˜`;
        }

        // è‡ªåŠ¨åŒæ­¥æ˜¨æ—¥è®¡åˆ’åˆ°ä»Šæ—¥å·¥ä½œ
        function autoSyncPlanToWork() {
            const today = getToday();
            const yesterday = getYesterday();
            const history = JSON.parse(localStorage.getItem('review-history') || '{}');
            if (history[today]) return;
            if (history[yesterday] && history[yesterday].plan.text) {
                document.getElementById('work-today').innerHTML = history[yesterday].plan.text;
            }
        }

        // ä¼ å›¾åŠŸèƒ½
        function uploadImgToText(textareaId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imgUrl = event.target.result;
                    const textbox = document.getElementById(textareaId);
                    const img = document.createElement('img');
                    img.src = imgUrl;
                    img.style.maxWidth = '100px';
                    img.style.maxHeight = '100px';
                    img.style.verticalAlign = 'middle';
                    img.style.margin = '0 4px';
                    const selection = window.getSelection();
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(img);
                    range.setStartAfter(img);
                    selection.removeAllRanges();
                    selection.addRange(range);
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        // è‡ªåŠ¨ä¿å­˜æ ¸å¿ƒæ–¹æ³•
        function saveCore() {
            const today = getToday();
            const getContent = id => document.getElementById(id).innerHTML;
            const data = {
                date: today,
                work: { text: getContent('work-today') },
                plan: { text: getContent('plan-tomorrow') },
                reflection: { text: getContent('reflection-today') },
                blessing: { text: getContent('blessing-today') }
            };
            const history = JSON.parse(localStorage.getItem('review-history') || '{}');
            history[today] = data;
            localStorage.setItem('review-history', JSON.stringify(history));
            updateHistorySelect();
            showAutoSaveTip();
        }

        // è‡ªåŠ¨ä¿å­˜æç¤ºè¯­
        function showAutoSaveTip(){
            const tip = document.getElementById('auto-save-tip');
            tip.style.display = 'block';
            setTimeout(()=>{
                tip.style.display = 'none';
            },1500);
        }

        // å¼€å¯è‡ªåŠ¨ä¿å­˜ï¼ˆè¾“å…¥åœ1ç§’è‡ªåŠ¨å­˜ï¼‰
        function initAutoSave(){
            const editBoxes = ['work-today','plan-tomorrow','reflection-today','blessing-today'];
            editBoxes.forEach(id=>{
                const box = document.getElementById(id);
                box.addEventListener('input',()=>{
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(()=>{
                        saveCore();
                    },1000);
                });
            });
        }

        // æ›´æ–°å†å²æ—¥æœŸä¸‹æ‹‰æ¡†
        function updateHistorySelect() {
            const history = JSON.parse(localStorage.getItem('review-history') || '{}');
            const dates = Object.keys(history).sort().reverse();
            const select = document.getElementById('history-date');
            select.innerHTML = '<option value="">æŸ¥çœ‹å¾€æ—¥è®°å½•</option>';
            dates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                select.appendChild(option);
            });
        }

        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            const date = document.getElementById('history-date').value;
            if (!date) return;
            const history = JSON.parse(localStorage.getItem('review-history') || '{}');
            const data = history[date];
            if (!data) return;
            document.getElementById('work-today').innerHTML = data.work.text;
            document.getElementById('plan-tomorrow').innerHTML = data.plan.text;
            document.getElementById('reflection-today').innerHTML = data.reflection.text;
            document.getElementById('blessing-today').innerHTML = data.blessing.text;
        }

        // åˆ é™¤å†å²è®°å½•
        function deleteHistory() {
            const date = document.getElementById('history-date').value;
            if (!date) {
                alert("è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•æ—¥æœŸï¼");
                return;
            }
            if (confirm(`ç¡®å®šåˆ é™¤ ${date} å¤ç›˜è®°å½•ï¼Ÿ`)) {
                const history = JSON.parse(localStorage.getItem('review-history') || '{}');
                delete history[date];
                localStorage.setItem('review-history', JSON.stringify(history));
                updateHistorySelect();
                ['work-today','plan-tomorrow','reflection-today','blessing-today'].forEach(id => document.getElementById(id).innerHTML='');
                alert("è®°å½•å·²åˆ é™¤ï¼");
            }
        }

        // è·¨æ—¥è‡ªåŠ¨ä¿å­˜æ£€æµ‹
        function checkDateChange() {
            const newDate = getToday();
            if (newDate !== currentDate) {
                saveCore(); // è·¨æ—¥è‡ªåŠ¨å­˜æ˜¨æ—¥å†…å®¹
                currentDate = newDate;
                setHeaderTitle();
                autoSyncPlanToWork();
                updateHistorySelect();
                ['work-today','plan-tomorrow','reflection-today','blessing-today'].forEach(id => document.getElementById(id).innerHTML='');
                alert(`å·²è‡ªåŠ¨ä¿å­˜æ˜¨æ—¥è®°å½•ï¼Œåˆ‡æ¢è‡³ä»Šæ—¥å¤ç›˜ï¼`);
            }
        }

        // æœç´¢åŠŸèƒ½
        function searchRecords() {
            const keyword = document.getElementById('search-input').value.trim().toLowerCase();
            if (!keyword) {alert("è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼");return;}
            const history = JSON.parse(localStorage.getItem('review-history') || '{}');
            const resultList = document.getElementById('result-list');
            resultList.innerHTML = '';
            let hasResult = false;
            for (const [date, record] of Object.entries(history)) {
                const workText = record.work.text.toLowerCase();
                const planText = record.plan.text.toLowerCase();
                const reflectionText = record.reflection.text.toLowerCase();
                const blessingText = record.blessing.text.toLowerCase();
                if (workText.includes(keyword) || planText.includes(keyword) || reflectionText.includes(keyword) || blessingText.includes(keyword)) {
                    hasResult = true;
                    const stripTags = (html) => html.replace(/<img[^>]*>/g, '[å›¾ç‰‡]').replace(/<[^>]*>/g, '');
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item';
                    resultItem.innerHTML = `<div class="result-date">æ—¥æœŸï¼š${date}</div><div class="result-content"><strong>å·¥ä½œï¼š</strong>${stripTags(record.work.text)||'æ— '}</div><div class="result-content"><strong>è®¡åˆ’ï¼š</strong>${stripTags(record.plan.text)||'æ— '}</div><div class="result-content"><strong>åæ€ï¼š</strong>${stripTags(record.reflection.text)||'æ— '}</div><div class="result-content"><strong>å°ç¡®å¹¸ï¼š</strong>${stripTags(record.blessing.text)||'æ— '}</div>`;
                    resultList.appendChild(resultItem);
                }
            }
            if (!hasResult) {resultList.innerHTML = '<div style="text-align:center;color:#999;">æ— åŒ¹é…è®°å½•</div>';}
            document.getElementById('search-modal').style.display = 'flex';
        }

        // å…³é—­å¼¹çª—
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // å‘¨/æœˆæ±‡æ€»
        function generateSummary() {
            const history = JSON.parse(localStorage.getItem('review-history') || '{}');
            if (Object.keys(history).length === 0) {alert("æš‚æ— è®°å½•å¯æ±‡æ€»ï¼");return;}
            const summaryType = document.getElementById('summary-type').value;
            const today = new Date();
            let filterRecords = [];
            let summaryTitle = '';
            if (summaryType === 'week') {
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay() + 1);
                weekStart.setHours(0,0,0,0);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                summaryTitle = `${formatDate(weekStart)} - ${formatDate(weekEnd)} å‘¨æ±‡æ€»`;
                filterRecords = Object.values(history).filter(record => {const d=new Date(record.date);return d>=weekStart&&d<=weekEnd;});
            } else {
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const monthEnd = new Date(today.getFullYear(), today.getMonth()+1, 0);
                summaryTitle = `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ æœˆæ±‡æ€»`;
                filterRecords = Object.values(history).filter(record => {const d=new Date(record.date);return d>=monthStart&&d<=monthEnd;});
            }
            if (filterRecords.length === 0) {alert("å½“å‰å‘¨æœŸæ— è®°å½•ï¼");return;}
            const stripTags = (html) => html.replace(/<img[^>]*>/g, '[å›¾ç‰‡]').replace(/<[^>]*>/g, '');
            const workSummary = filterRecords.map(r=>stripTags(r.work.text)).filter(t=>t).join('ï¼›');
            const planSummary = filterRecords.map(r=>stripTags(r.plan.text)).filter(t=>t).join('ï¼›');
            const reflectionSummary = filterRecords.map(r=>stripTags(r.reflection.text)).filter(t=>t).join('ï¼›');
            const blessingSummary = filterRecords.map(r=>stripTags(r.blessing.text)).filter(t=>t).join('ï¼›');
            document.getElementById('summary-title').innerText = summaryTitle;
            document.getElementById('summary-content').innerHTML = `<div class="summary-section"><h3>å·¥ä½œå†…å®¹</h3><p>${workSummary||'æ— è®°å½•'}</p></div><div class="summary-section"><h3>è®¡åˆ’å®‰æ’</h3><p>${planSummary||'æ— è®°å½•'}</p></div><div class="summary-section"><h3>åæ€æ€»ç»“</h3><p>${reflectionSummary||'æ— è®°å½•'}</p></div><div class="summary-section"><h3>å°ç¡®å¹¸é›†é”¦</h3><p>${blessingSummary||'æ— è®°å½•'}</p></div><div class="summary-section"><h3>ç»Ÿè®¡</h3><p>å‘¨æœŸå†…å¤ç›˜${filterRecords.length}æ¡</p></div>`;
            document.getElementById('summary-modal').style.display = 'flex';
        }

        // æ—¥æœŸæ ¼å¼åŒ–
        function formatDate(date) {
            return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
        }

        // ä¸€é”®å¯¼å‡ºè®°å½•ï¼ˆæ¢æµè§ˆå™¨åŒæ­¥ç”¨ï¼‰
        function exportData() {
            const data = localStorage.getItem('review-history');
            if (!data) {alert("æš‚æ— å¤ç›˜è®°å½•å¯å¯¼å‡ºï¼");return;}
            const blob = new Blob([data], {type: 'application/json'});
            saveAs(blob, `å¤ç›˜è®°å½•_${getToday()}.json`);
        }

        // ä¸€é”®å¯¼å…¥è®°å½•ï¼ˆæ¢æµè§ˆå™¨åŒæ­¥ç”¨ï¼‰
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        JSON.parse(reader.result);
                        localStorage.setItem('review-history', reader.result);
                        updateHistorySelect();
                        loadTodayRecord();
                        alert("å¯¼å…¥æˆåŠŸï¼æ‰€æœ‰è®°å½•å·²åŒæ­¥");
                    } catch (err) {
                        alert("å¯¼å…¥å¤±è´¥ï¼æ–‡ä»¶æ ¼å¼é”™è¯¯");
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // æ‰“å¼€é»˜è®¤æ˜¾ç¤ºä»Šæ—¥è®°å½•
        function loadTodayRecord() {
            const today = getToday();
            const history = JSON.parse(localStorage.getItem('review-history') || '{}');
            if (history[today]) {
                document.getElementById('work-today').innerHTML = history[today].work.text;
                document.getElementById('plan-tomorrow').innerHTML = history[today].plan.text;
                document.getElementById('reflection-today').innerHTML = history[today].reflection.text;
                document.getElementById('blessing-today').innerHTML = history[today].blessing.text;
            } else {
                document.getElementById('work-today').innerHTML = '';
                document.getElementById('plan-tomorrow').innerHTML = '';
                document.getElementById('reflection-today').innerHTML = '';
                document.getElementById('blessing-today').innerHTML = '';
                autoSyncPlanToWork();
            }
        }

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.onload = function() {
            setHeaderTitle();
            updateHistorySelect();
            loadTodayRecord();
            initAutoSave();
            setInterval(checkDateChange, 10000);
        };
    </script>
</body>
</html>
